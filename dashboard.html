import express from "express";
import cors from "cors";

const app = express();
const port = process.env.PORT || 3000;

app.use(cors());
app.use(express.json());

// In-memory opslag van coin-data en trades
let coinsData = [];
let tradesData = [];

// Healthcheck
app.get("/", (req, res) => {
  res.send("JPBot Dashboard API is running");
});

// Frontend haalt coins op
app.get("/api/coins", (req, res) => {
  res.json(coinsData);
});

// Frontend haalt trades op
app.get("/api/trades", (req, res) => {
  res.json(tradesData);
});

// JPBot stuurt nieuwe coin data
app.post("/api/coins", (req, res) => {
  const newData = req.body;
  if (!Array.isArray(newData)) {
    return res.status(400).json({ status: "error", message: "Data moet een array zijn" });
  }
  coinsData = newData;
  console.log("âœ… Coins data ontvangen:", coinsData);
  res.json({ status: "ok", message: "Data ontvangen!" });
});

// JPBot stuurt nieuwe trades data
app.post("/api/trades", (req, res) => {
  const newTrades = req.body;
  if (!Array.isArray(newTrades)) {
    return res.status(400).json({ status: "error", message: "Data moet een array zijn" });
  }
  tradesData = newTrades;
  console.log("âœ… Trades data ontvangen:", tradesData);
  res.json({ status: "ok", message: "Trades ontvangen!" });
});

// Dashboard pagina
app.get("/dashboard.html", (req, res) => {
  res.send(`<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>JPBot Dashboard</title>
<style>
  body { font-family: 'Arial', sans-serif; margin:0; padding:0; background:#121212; color:#eee; }
  header { padding:20px; text-align:center; font-size:28px; background:#1f1f1f; color:#f5a623; }
  .section { padding:20px; }
  h2 { margin-bottom:10px; color:#f5a623; }
  .grid { display:flex; flex-wrap:wrap; gap:15px; }
  .card { background:#1f1f1f; border-radius:10px; padding:15px; min-width:150px; flex:1 1 150px; box-shadow:0 0 10px #000; transition:transform 0.2s; }
  .card:hover { transform:scale(1.05); }
  .symbol { font-weight:bold; font-size:18px; margin-bottom:5px; }
  .value { font-size:14px; }
  .price { color:#4caf50; }
  .loss { color:#f44336; }
  .trades-card { background:#272727; border:1px solid #444; }
  .scrollable { max-height:400px; overflow-y:auto; padding-right:10px; }
</style>
</head>
<body>
<header>ðŸ¤– JPBot Dashboard</header>

<div class="section">
  <h2>ðŸ“ˆ Coins</h2>
  <div class="grid" id="coins"></div>
</div>

<div class="section">
  <h2>ðŸ’¹ Actieve Trades</h2>
  <div class="grid scrollable" id="trades"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
async function fetchData() {
  const coins = await fetch('/api/coins').then(r=>r.json());
  const trades = await fetch('/api/trades').then(r=>r.json());

  const coinsDiv = document.getElementById('coins');
  coinsDiv.innerHTML = coins.map(c => \`
    <div class="card">
      <div class="symbol">\${c.symbol}</div>
      <div class="value">Pair: \${c.pair}</div>
      <div class="value">Balance: \${c.balance}</div>
      <div class="value">Price: <span class="\${c.currentPrice > 0 ? 'price' : 'loss'}">â‚¬\${c.currentPrice.toFixed(2)}</span></div>
    </div>\`).join('');

  const tradesDiv = document.getElementById('trades');
  tradesDiv.innerHTML = trades.map(t => \`
    <div class="card trades-card">
      <div class="symbol">\${t.symbol}</div>
      <div class="value">Entry: â‚¬\${t.entryPrice.toFixed(2)}</div>
      <div class="value">Current: â‚¬\${t.currentPrice.toFixed(2)}</div>
      <div class="value">Amount: \${t.amount}</div>
      <div class="value">Profit: <span class="\${t.profitPercent >= 0 ? 'price' : 'loss'}">\${t.profitPercent.toFixed(2)}%</span></div>
    </div>\`).join('');
}

// Refresh elke 2 seconden
setInterval(fetchData, 2000);
fetchData();
</script>
</body>
</html>`);
});

app.listen(port, () => {
  console.log(`JPBot Dashboard API running on port ${port}`);
});
