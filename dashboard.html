import express from "express";
import cors from "cors";

const app = express();
const port = process.env.PORT || 3000;

app.use(cors());
app.use(express.json());

// In-memory data
let coinsData = [];
let tradesData = [];

// API endpoints
app.get("/api/coins", (req, res) => res.json(coinsData));
app.get("/api/trades", (req, res) => res.json(tradesData));

app.post("/api/coins", (req, res) => {
    const newData = req.body;
    if (!Array.isArray(newData)) return res.status(400).json({ status: "error", message: "Data moet een array zijn" });
    coinsData = newData;
    console.log("✅ Coins data ontvangen:", coinsData);
    res.json({ status: "ok" });
});

app.post("/api/trades", (req, res) => {
    const newTrades = req.body;
    if (!Array.isArray(newTrades)) return res.status(400).json({ status: "error", message: "Data moet een array zijn" });
    tradesData = newTrades;
    console.log("✅ Trades data ontvangen:", tradesData);
    res.json({ status: "ok" });
});

// Inline dashboard
app.get("/dashboard.html", (req, res) => {
    res.send(`<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>JPBot Dashboard</title>
<style>
  body { font-family: Arial, sans-serif; margin:0; background:#121212; color:#fff; }
  h1 { text-align:center; margin:20px 0; color:#00ffcc; }
  .container { display:flex; flex-wrap:wrap; justify-content:center; gap:20px; padding:10px; }
  .card { background:#1e1e1e; padding:15px; border-radius:12px; width:220px; box-shadow:0 0 15px rgba(0,255,200,0.2); }
  .coin { font-weight:bold; font-size:1.2em; margin-bottom:5px; }
  .price { color:#00ffcc; font-weight:bold; }
  .balance { color:#fff; margin-top:5px; }
  .trade-card { background:#333; padding:12px; border-radius:10px; width:260px; box-shadow:0 0 10px rgba(0,255,200,0.3); margin:10px; }
  .trade-header { font-weight:bold; margin-bottom:5px; color:#ffcc00; }
  .scroll-container { max-height:500px; overflow-y:auto; padding:10px; }
</style>
</head>
<body>
<h1>JPBot Dashboard</h1>
<div class="container" id="coinsContainer"></div>

<h2 style="text-align:center; margin-top:30px; color:#ffcc00;">Actieve Trades</h2>
<div class="scroll-container" id="tradesContainer"></div>

<script>
async function fetchData() {
    try {
        const coinsRes = await fetch("/api/coins");
        const tradesRes = await fetch("/api/trades");
        const coins = await coinsRes.json();
        const trades = await tradesRes.json();

        const coinsContainer = document.getElementById("coinsContainer");
        coinsContainer.innerHTML = "";
        coins.forEach(c => {
            const card = document.createElement("div");
            card.className = "card";
            card.innerHTML = \`
                <div class="coin">\${c.symbol}</div>
                <div class="price">€\${c.currentPrice.toLocaleString()}</div>
                <div class="balance">Balance: \${c.balance}</div>
                <div>Pair: \${c.pair}</div>
            \`;
            coinsContainer.appendChild(card);
        });

        const tradesContainer = document.getElementById("tradesContainer");
        tradesContainer.innerHTML = "";
        trades.forEach(t => {
            const tcard = document.createElement("div");
            tcard.className = "trade-card";
            tcard.innerHTML = \`
                <div class="trade-header">\${t.coin.symbol} Trade</div>
                <div>Entry: €\${t.entryPrice.toFixed(2)}</div>
                <div>Amount: \${t.amount}</div>
                <div>Current: €\${t.coin.currentPrice.toFixed(2)}</div>
                <div>Stop Loss: €\${t.stopLoss.toFixed(2)}</div>
            \`;
            tradesContainer.appendChild(tcard);
        });
    } catch(err) {
        console.error("Error fetching data:", err);
    }
}

// Update elke 5 seconden
fetchData();
setInterval(fetchData, 5000);
</script>
</body>
</html>`);
});

app.listen(port, () => {
    console.log(`JPBot Dashboard API running on port ${port}`);
});
