<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JPBot Dashboard</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-900 text-white font-sans min-h-screen">

    <header class="bg-gray-800 p-4 text-center">
        <h1 class="text-3xl font-bold text-yellow-400">JPBot Dashboard</h1>
        <p class="text-gray-300 mt-1">Realtime crypto portfolio & prices</p>
    </header>

    <main class="p-4 max-w-7xl mx-auto">

        <!-- Portfolio overview -->
        <section class="mb-8">
            <div class="bg-gray-800 rounded-xl p-6 flex flex-col md:flex-row items-center justify-between">
                <div>
                    <h2 class="text-xl font-semibold text-gray-300">Portfolio Value</h2>
                    <p class="text-4xl font-bold text-green-400" id="portfolioValue">€0.00</p>
                </div>
                <div class="w-full md:w-1/2 mt-4 md:mt-0">
                    <canvas id="portfolioChart" height="80"></canvas>
                </div>
            </div>
        </section>

        <!-- Coins grid -->
        <section>
            <h2 class="text-xl font-semibold text-gray-300 mb-4">Coins</h2>
            <div id="coinsGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                <!-- Coin cards injected here -->
            </div>
        </section>
    </main>

    <footer class="bg-gray-800 p-4 text-center text-gray-400 mt-8">
        JPBot Dashboard &copy; 2026
    </footer>

    <script>
        const apiUrl = "/api/coins";

        const portfolioData = [];

        async function fetchCoins() {
            try {
                const res = await fetch(apiUrl);
                const data = await res.json();

                updatePortfolio(data);
                renderCoins(data);
            } catch (error) {
                console.error("Error fetching coins:", error);
            }
        }

        function updatePortfolio(coins) {
            const eurBalance = coins.reduce((sum, c) => sum + (c.balance * c.currentPrice), 0);
            document.getElementById("portfolioValue").textContent = `€${eurBalance.toFixed(2)}`;

            // Keep last 30 values for chart
            portfolioData.push(eurBalance);
            if (portfolioData.length > 30) portfolioData.shift();

            renderPortfolioChart();
        }

        function renderPortfolioChart() {
            const ctx = document.getElementById('portfolioChart').getContext('2d');
            if (window.portfolioChartInstance) {
                window.portfolioChartInstance.data.labels = portfolioData.map((_, i) => i);
                window.portfolioChartInstance.data.datasets[0].data = portfolioData;
                window.portfolioChartInstance.update();
                return;
            }

            window.portfolioChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: portfolioData.map((_, i) => i),
                    datasets: [{
                        label: 'Portfolio €',
                        data: portfolioData,
                        borderColor: '#FACC15',
                        backgroundColor: 'rgba(250, 204, 21, 0.2)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function renderCoins(coins) {
            const grid = document.getElementById("coinsGrid");
            grid.innerHTML = '';

            coins.forEach(coin => {
                const priceChangeClass = coin.currentPrice > 0 ? 'text-green-400' : 'text-gray-400';

                const card = document.createElement("div");
                card.className = "bg-gray-800 rounded-xl p-4 flex flex-col items-center shadow hover:shadow-lg transition";

                card.innerHTML = `
                    <h3 class="text-lg font-bold mb-2">${coin.symbol}</h3>
                    <p class="text-gray-400 text-sm mb-1">${coin.pair}</p>
                    <p class="${priceChangeClass} font-semibold text-xl">€${coin.currentPrice.toFixed(2)}</p>
                    <p class="text-gray-300 text-sm mt-1">Balance: ${coin.balance}</p>
                    <canvas id="spark-${coin.symbol}" class="mt-2" height="50"></canvas>
                `;

                grid.appendChild(card);

                // Sparkline
                const ctx = document.getElementById(`spark-${coin.symbol}`).getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: Array(10).fill(''),
                        datasets: [{
                            data: Array(10).fill(coin.currentPrice),
                            borderColor: '#FACC15',
                            backgroundColor: 'rgba(250, 204, 21, 0.2)',
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: { x: { display: false }, y: { display: false } }
                    }
                });
            });
        }

        // Poll every 5 seconds
        fetchCoins();
        setInterval(fetchCoins, 5000);
    </script>
</body>
</html>
